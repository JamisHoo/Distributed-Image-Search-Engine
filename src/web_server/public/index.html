<html>
    <head>
        <meta charset="uft-8">
        <link rel="stylesheet" href="semantic/packaged/javascript/semantic.min.js">
        <link rel="stylesheet" href="semantic/packaged/css/semantic.min.css">
        <title>Image Search Engine</title>
        <meta name="description" content="">
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
        <link rel="stylesheet" href="jquery-2.1.1.js"> 
        <link rel="stylesheet" href="jquery.lazyload.js"> 
    </head>
    <body>
        <input type="hidden" id="computing_node" value="COMPUTING_NODE_HOST">
        <input type="hidden" id="storage_node" value="STORAGE_NODE_HOST">
        <h3 class="ui teal inverted menu">
            <div class="ui large action input">
                <input type="text" placeholder="Search..." name="word" id="submit" style="height:50px;overflow-x:auto;" autofocus>
                <a class="ui blue button" id="SearchButton" onclick="Search()">Search<i class="search icon"></i></a>
            </div>
        </h3>
        <div class="ui horizontal icon divider">
        <i class="circular cloud icon"></i>
        </div>
        <div class="ui three column grid">
            <div class="five wide column">
                <p><FONT size=10 color="#FF7E7E"><i class="file outline icon"></i><STRONG>Choose</STRONG></FONT><FONT size=2><strong> an image</strong></FONT></p>
                <div class="ui segment attached" style="height:600px; overflow-x:auto; display: inline-block; position:relative" id="view" onScroll="viewscroll()">
                    <div class="ui small images" id="image_container"> 

                    </div>
                    <div id="loading" style="position:relative; "></div>
                </div>
                
            </div>
            <div class="six wide column">
                <p><FONT size=10 color="#FF7E7E"><i class="zoom in icon"></i><STRONG>View</STRONG></FONT><FONT size=2><STRONG> image</STRONG></FONT></p>
                <div class="ui segment"  style="height:600px;">
                <!--can delete this line-->
                <!--can delete this line-->
                <img  class="rounded ui image" src="" id="ViewerImage" style="height:580px; width:580px;">
                </div>
            </div>
            <div class="five wide column">
                <p><FONT size=10 color="#FF7E7E"><i class="cart icon"></i><STRONG>Use</STRONG></FONT><FONT size=2><STRONG>it the way you want</STRONG></FONT></p>

                <div class="ui segment">
                <!--can delete this line
                <div class="ui active inverted dimmer"><div class="ui medium text loader"><STRONG>Loading</STRONG></div></div>
                can delete this line-->
                        <div class="ui red form segment">
                            <div class="inline fields">
                                <div class="field">
                                    <FONT><STRONG>Image Download</STRONG></FONT>
                                </div>
                                <div class="field">
                                    <img class='small ui image'src='' id='DownloadImage' style="vertical-align:middle">
                                </div>
                                <div class="field">
                                    <a href="" download="" id="downimage"><div class="small ui green button">Download</div></a>
                                </div>
                            </div>
                        </div>

                        <div class="ui red form segment">
                            <div class="inline fields">
                                <div class="field">
                                    <FONT><STRONG>Link</STRONG></FONT>
                                </div>
                                <div class="field">
                                    <input type="text" value="" name="link" id="link_text" >
                                </div>
                                <div class="field">
                                    <div class="small ui green button" onClick="Print()">Copy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                </div>
            </div>
        </div>

        <input type="hidden" id="loaded_counter" value="0">
        <script>
            $(document).keypress(function(e){
                if (e.which == 13){
                    $('#SearchButton').click();   
                }
            });
            var N = 50;
            var xmlHttp = new XMLHttpRequest();
            var word;
            var count;
            var last_click_id;
            function Search() {
                count = 0;
                word = "";
                var computing_node = $("#computing_node").val();
                var com_ar = computing_node.split(":");
                //var sto_ar = storage_node.split(":");
                //alert(computing_node);
                if (computing_node) {
                    /*$.get(
                        "http://127.0.0.1:10000?keyword=1234",
                        function(data) {
                            alert(data);
                        }
                    )*/
                    word = $("#submit").val();
                    xmlHttp.open("GET", "http://"+com_ar[0]+":"+com_ar[1]+"?keywords="+word, false);
                    xmlHttp.send(null);
                    var result = xmlHttp.responseText ;
                    console.log(result);
                    Submit(result);
                }
            }
            var idx_array;
            function Submit(imageidx) {
                var idxstring = String(imageidx) ;
                //alert(idxstring)
                var idx = idxstring.split(';');
                //alert(idx.length);
                idx_array = new Array(idx.length);
                for (var i = 0 ; i < idx.length; ++i) {
                    //idx_array[i] = new Array(3);
                    idx_array[i] = idx[i].split(',');
                }
                load();
            }
            function load() {
                var curr = parseInt($("#loaded_counter").val());
                var storage_node = $("#storage_node").val();
                var sto_ar = storage_node.split(":");
                var end = curr + N;
                var ToAdd = "";
                //alert(curr);
                //alert(end);
                if (end > idx_array.length)  end = idx_array.length;
                for (var i = curr; i <= end; ++i) {
                    var src = "http://"+sto_ar[0]+":"+sto_ar[1]+"?block_no="+idx_array[i][0]
                        +"&offset="+idx_array[i][1]
                        +"&length="+idx_array[i][2];
                    ToAdd += "<img src='"+src+"'border=0 id='img"+count+"'onclick='loadOnViewer(this)'onmouseover='' style='height:100px; width:100px; cursor:pointer'>";
                    count += 1;
                }
                //alert(ToAdd);
                var now = $("#image_container").html(); 
                $("#image_container").html(now + ToAdd); 
                curr = end + N + 1;
                $("#loaded_counter").val(String(curr));
                $("#loading").html("");
            }
            function loadOnViewer(img) {
                var src = img.src;
                $('#'+last_click_id).attr('border', 0);
                last_click_id = img.id;
                img.border = 5;
                $('#ViewerImage').attr("src", src);
                $('#DownloadImage').attr("src", src);
                $('#downimage').attr("href", src);
                $('#downimage').attr("download", word);
                $('#link_text').val(src);
            }
            function Print(){
                var LINK=document.getElementById("link_text"); 
                LINK.select(); 
                document.execCommand("Copy");
                alert("Copied!"); 
            }
            function viewscroll(){
                var a=document.getElementById("view");
                var f=a.clientHeight;
                console.log("clientHeight:"+f);
                var g=a.scrollTop;
                console.log("scrollTop:"+g);
                var h = a.scrollHeight;
                console.log("scrollHeight:"+h);
                if(f+g==h)
                {
                    $("#loading").html("<div class='ui active inverted dimmer' ><div class='ui medium text loader'><STRONG>Loading</STRONG></div></div>");
                    //alert("The end!");
                    load();
                }
            }
        </script>
    </body>
</html>
