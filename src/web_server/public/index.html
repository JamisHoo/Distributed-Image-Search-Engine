<!DOCTYPE html>
<html>
    <head>
        <meta charset="uft-8">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
        <link rel="stylesheet" href="semantic/packaged/javascript/semantic.min.js">
        <link rel="stylesheet" href="semantic/packaged/css/semantic.min.css">
        <link rel="stylesheet" href="http://www.w3schools.com/w3css/w3.css">
        <!--link rel="stylesheet" type="text/css" href="semantic/out/semantic.min.css">
        <script src="semantic/out/semantic.min.js"></script-->
        <title>Image Search Engine</title>
        <meta name="description" content="">
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="jquery-2.1.1.js"> 
        <link rel="stylesheet" href="jquery.lazyload.js">   
        <style>
            /*#view {
                height:59.1vh;
            }
            #Viewer {
                height:59.1vh;
            }
            #ViewerImage{
                height:59.1vh;
                width:30.2vw;
            }
            .smallimg{
                height:11.7vh;
                width:11.7vh;
            }*/
        </style>
    </head>
    <body onresize="Resize()">
        <input type="hidden" id="computing_node" value="COMPUTING_NODE_HOST">
        <input type="hidden" id="storage_node" value="STORAGE_NODE_HOST">
        <h3 class="ui teal inverted menu">
            <div class="ui large action input">
                <input type="text" placeholder="Search..." name="word" id="submittext" style="height:50px;overflow-x:auto;" autofocus>
                <a class="ui blue button" id="SearchButton" onclick="Search()">Search<i class="search icon"></i></a>
            </div>
        </h3>
        <div class="ui horizontal icon divider"><i class="circular cloud icon"></i></div>
        <div id="noresult" style="display:none">
            <h1 class="ui inverted black block header">NO RESULT</h1>
        </div>
        <div id="searchresult" style="display:none">
        <div class="ui three column grid">
            <div class="five wide column">
                <div class="ui red header" style="display:inline"><i class="file outline icon"></i><STRONG>Choose</STRONG><div class="sub header">an image</div></div>
                <div class="ui segment" style="overflow:scroll; display: inline-block;position:relative;" id="view" onScroll="viewscroll()">
                    <div class="ui small images" id="image_container" > 

                    </div>
                    <!--div id="loading" style="position:relative; "></div-->
                </div>
                
            </div>
            <div class="six wide column">
                <div class="ui red header" style="display:inline"><i class="zoom in icon"></i><STRONG>View</STRONG><div class="sub header"> image</div></div>
                <div class="ui segment"  style="" id="Viewer">
                    <img  class="rounded ui image" src="" id="ViewerImage" style="">
                </div>
            </div>
            <div class="five wide column">
                <div class="ui red header" style="display:inline"><i class="cart icon"></i><STRONG>Use</STRONG><div class="sub header">it the way you want</div></div>
                <div class="ui segment">
                    <div class="ui red form segment" id="redform1">
                        <div class="inline fields">
                            <div class="ui black header" id="literal1">Image Download</div>
                            <img class='small ui image'src=''id='DownloadImage'style="border-style:solid; border-width:1px; border-color:black; ">
                            <a href="" id="downimage" download="" ><div class="small ui green button" id="downbt"style="margin-top:10px;">Download</div></a>
                        </div>
                    </div>
                    <div class="ui red form segment" id="redform2">
                        <div class="inline fields" style="display:inline-block;">
                            <div class="ui black header" id="literal2">Link</div>
                            <input type="text" value="" name="link" id="link_text" >
                            <div class="small ui green button" id="copybt"style="float:left;display:inline; margin-top:10px;" onClick="Copy()">Copy</div>
                            <div class="ui red header"style="display:none;float:left;vertical-align:middle;margin-left:20px; margin-top:10px;" id="copied">Copied</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="loaded_counter" value="0">
        <script>

            $(document).ready(function(){
                var w = window,
                d = document,
                e = d.documentElement,
                g = d.getElementsByTagName('body')[0],
                x = w.innerWidth || e.clientWidth || g.clientWidth,
                y = w.innerHeight|| e.clientHeight|| g.clientHeight;
                //alert(x + ' Ã— ' + y);
                //input text width
                $("#submittext").css("width", (parseInt(x)*0.4).toString() + "px");
            })
            $(document).keypress(function(e){
                if (e.which == 13){
                    $('#SearchButton').click();
                }
            });
            var N = 50;
            var xmlHttp = new XMLHttpRequest();
            var word;
            var count;
            var last_click_id;
            function Search() {
                //alert( $('#view').css('height') ) ;
                $("#loaded_counter").val("0");
                $("#image_container").html("");
                $("#ViewerImage").attr("src","");
                $("#DownloadImage").attr("src","");
                $("#link_text").val("");
                //var count = 0;
                //var last_click_id;
                count = 0;
                word = "";
                var computing_node = $("#computing_node").val();
                //alert(computing_node);
                var com_ar = computing_node.split(":");
                //var sto_ar = storage_node.split(":");
                //alert(computing_node);
                if (computing_node) {
                    word = $("#submittext").val();
                    xmlHttp.open("GET", "http://"+com_ar[0]+":"+com_ar[1]+"?keywords="+word, false);
                    xmlHttp.send(null);
                    var result = xmlHttp.responseText ;
                    //alert(result);
                    if (result == "") {
                        alert("none!");
                        $("#noresult").css("display", "block");
                        $("#searchresult").css("display", "none");
                        return;
                    }
                    $("#noresult").css("display", "none");
                    $("#searchresult").css("display","block");
                    console.log(result);
                    Submit(result);
                }
            }
            var idx_array;
            function Submit(imageidx) {
                var idxstring = String(imageidx) ;
                //alert(idxstring)
                var idx = idxstring.split(';');
                //alert(idx.length);
                idx_array = new Array(idx.length);
                for (var i = 0 ; i < idx.length; ++i) {
                    //idx_array[i] = new Array(3);
                    idx_array[i] = idx[i].split(',');
                }
                load();
            }
            function load() {
                var curr = parseInt($("#loaded_counter").val());
                var storage_node = $("#storage_node").val();
                var sto_ar = storage_node.split(":");
                var end = curr + N;
                var ToAdd = "";
                //alert(curr);
                //alert(end);
                if (end > idx_array.length)  end = idx_array.length;
                for (var i = curr; i <= end; ++i) {
                    var src = "http://"+sto_ar[0]+":"+sto_ar[1]+"?block_no="+idx_array[i][0]
                        +"&offset="+idx_array[i][1]
                        +"&length="+idx_array[i][2];
                        ToAdd += "<img onmouseenter='EnterEvent(this)' onmouseleave='LeaveEvent(this)' class='smallimg' src='"+src+"' id='img"+count+"'onclick='loadOnViewer(this)' style='cursor:pointer; border-style:solid; border-width:2px; border-color:black;'>";
                    count += 1;
                }
                //alert(ToAdd);
                var now = $("#image_container").html(); 
                $("#image_container").html(now + ToAdd); 
                curr = end + N + 1;
                $("#loaded_counter").val(String(curr));
                $("#loading").html("");
                $("#img0").click();  //focus on the first image

                //$(".smallimg").css("width", '11.7vh');
                //var y = $(".smallimg").css('height');
                //var x = $(".smallimg").css('width');
                //alert(y + "," + x);
            }
            function EnterEvent(img) {
                if ($(img).css('border-color')!='green') 
                    $(img).css('border-color','red');
            }
            function LeaveEvent(img) {
                if($(img).css('border-color')!='green') 
                    $(img).css('border-color','black');
            }
            function loadOnViewer(img) {
                var src = img.src;
                $('#'+last_click_id).attr('border', 0);
                $("#copybt").attr("class", "small ui green button");
                $("#copybt").html("Copy");
                $(img).css("border-color", "green");
                $("#"+last_click_id).css("border-color", "");
                last_click_id = img.id;
                img.border = 5;
                $('#ViewerImage').attr("src", src);
                $('#DownloadImage').attr("src", src);
                $('#downimage').attr("href", src);
                $('#downimage').attr("download", word);
                $('#link_text').val(src);
                Resize();
            }
            function Copy(){
                var LINK=document.getElementById("link_text"); 
                LINK.select(); 
                document.execCommand("Copy");
                /*$("#copybt").attr("class", "small ui red button");
                $("#copybt").html("Copied");
                setTimeout(function(){
                    $("#copybt").attr("class", "small ui green button");
                    $("#copybt").html("Copy");
                    $("#link_text").blur();
                }, 2000);*/
                $("#copied").css("display", "inline");
                setTimeout(function(){
                    $("#copied").css("display", "none");
                    $("#link_text").blur();
                }, 2000);
            }
            function viewscroll(){
                var a=document.getElementById("view");
                var f=a.clientHeight;
                console.log("clientHeight:"+f);
                var g=a.scrollTop;
                console.log("scrollTop:"+g);
                var h = a.scrollHeight;
                console.log("scrollHeight:"+h);
                if(f+g==h)
                {
                    $("#loading").html("<div class='ui active inverted dimmer' ><div class='ui medium text loader'><STRONG>Loading</STRONG></div></div>");
                    //alert("The end!");
                    load();
                }
            }
            function Resize() {
                //link_text
                var Linkwid = (parseInt($('#redform2').css('width')) * 0.8).toString() + "px";
                $("#link_text").css('width', Linkwid);
                //Choose an image
                var wid = $("#image_container").css('width');
                var hei;
                $("#view").css('height', (parseInt(wid)).toString()+"px");
                var smallwid = Math.floor(parseInt(wid) / 5);
                $('.smallimg').css('width', smallwid.toString()+"px");
                $('.smallimg').css('height', smallwid.toString()+"px");
                //View image
                wid  = $("#Viewer").css('width');
                //var height = $("#Viewer").css('height');
                //var length = Math.min(parseInt(width), parseInt(height));
                //$("#Viewer").css('width' , length.toString()+"px");
                $("#Viewer").css('height', wid);
                //Download Image
                wid = $("#redform1").css('width');
                hei = $("#redform2").css('height');
                //$("#redform").css('height', (parseInt(wid)/3).toString()+"px");
                var fontsize = (parseInt(wid) / 20).toString() + "px";
                var eachwid  = (parseInt(wid) / 5).toString() + "px";
                var btheight = (parseInt(wid) / 9).toString() + "px";
                $("#literal1").css('fontSize', fontsize);
                $("#literal2").css('fontSize', fontsize);
                $("#DownloadImage").css({'width': eachwid, 'height': eachwid});
                //$("#link_text").css('height', );
                //$("#downbt").css({'width':eachwid,'height':btheight});
            }
        </script>
    </body>
</html>
